name: Deploy Backend to VPS

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy.yml'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP 8.3
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: pdo_pgsql, intl, xml, zip, curl, mbstring
          coverage: none

      - name: Validate composer.json
        working-directory: backend
        run: composer validate --strict

      - name: Create test .env file
        working-directory: backend
        run: |
          echo "APP_ENV=test" > .env
          echo "APP_SECRET=test-secret-key" >> .env
          echo "DATABASE_URL=postgresql://test:test@localhost:5432/test" >> .env

      - name: Install dependencies
        working-directory: backend
        run: composer install --optimize-autoloader --no-interaction --prefer-dist

      # - name: Run PHPStan
      #   working-directory: backend
      #   run: |
      #     if [ -f "vendor/bin/phpstan" ]; then
      #       vendor/bin/phpstan analyse
      #     else
      #       echo "PHPStan not found, skipping static analysis"
      #     fi

      - name: Run PHPUnit
        working-directory: backend
        run: |
          if [ -f "vendor/bin/phpunit" ]; then
            vendor/bin/phpunit
          else
            echo "PHPUnit not found, skipping tests"
          fi

  e2e-test:
    needs: test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright dependencies
        run: |
          npm ci
          npx playwright install --with-deps chromium

      - name: Start Docker Compose services
        run: docker compose up -d --wait

      - name: Wait for services to be ready
        run: |
          echo "Waiting for backend to be ready..."
          timeout 60 bash -c 'until curl -f http://localhost:8000/health 2>/dev/null; do sleep 2; done' || echo "Backend health check timed out"
          echo "Waiting for theme-builder to be ready..."
          timeout 60 bash -c 'until curl -f http://localhost:5173 2>/dev/null; do sleep 2; done' || echo "Theme-builder timed out"
          echo "Waiting for demo-shop to be ready..."
          timeout 60 bash -c 'until curl -f http://localhost:5174 2>/dev/null; do sleep 2; done' || echo "Demo-shop timed out"

      - name: Run Playwright E2E tests
        run: npx playwright test

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Stop Docker Compose
        if: always()
        run: docker compose down

  deploy:
    needs: e2e-test
    runs-on: ubuntu-latest
    environment: production

    env:
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_PORT: ${{ secrets.VPS_PORT }}
      VPS_USERNAME: ${{ secrets.VPS_USERNAME }}
      VPS_DEPLOY_PATH: ${{ secrets.VPS_DEPLOY_PATH }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      APP_SECRET: ${{ secrets.APP_SECRET }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.VPS_PORT }} -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy files via rsync
        run: |
          rsync -avz --delete --force \
            --exclude='.git' \
            --exclude='var/' \
            --exclude='vendor/' \
            --exclude='.env' \
            --exclude='.env.local' \
            --exclude='.env.test' \
            --exclude='docker/' \
            --exclude='docker-compose.yml' \
            --exclude='Dockerfile' \
            -e "ssh -i ~/.ssh/deploy_key -p ${{ secrets.VPS_PORT }} -o StrictHostKeyChecking=no" \
            backend/ ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:${{ secrets.VPS_DEPLOY_PATH }}/

      - name: Post-deployment tasks
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.VPS_PORT }} -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            cd ${{ secrets.VPS_DEPLOY_PATH }}

            # Update environment variables
            echo "APP_ENV=prod" > .env
            echo "APP_SECRET=${{ secrets.APP_SECRET }}" >> .env
            echo "DATABASE_URL=\"${{ secrets.DATABASE_URL }}\"" >> .env
            echo "DEFAULT_URI=https://tbapi.bieda.it" >> .env
            echo "CORS_ALLOW_ORIGIN=^https?://(localhost|tbapi\.bieda\.it|.*\.bieda\.it|demo-shop-two\.vercel\.app|theme-builder-two\.vercel\.app)(:[0-9]+)?$" >> .env
            echo "JWT_SECRET_KEY=%kernel.project_dir%/config/jwt/private.pem" >> .env
            echo "JWT_PUBLIC_KEY=%kernel.project_dir%/config/jwt/public.pem" >> .env
            echo "JWT_PASSPHRASE=" >> .env

            # Install dependencies
            composer install --no-dev --optimize-autoloader --no-interaction

            # Generate JWT keys if they don't exist
            if [ ! -f config/jwt/private.pem ]; then
              php bin/console lexik:jwt:generate-keypair --skip-if-exists
              chgrp www-data config/jwt/*.pem 2>/dev/null || true
              chmod 640 config/jwt/private.pem 2>/dev/null || true
              chmod 644 config/jwt/public.pem 2>/dev/null || true
              echo "JWT keys generated"
            else
              echo "JWT keys already exist, skipping generation"
            fi

            # Parse DATABASE_URL and export as PHINX_* environment variables
            DB_URL="${{ secrets.DATABASE_URL }}"
            export PHINX_DBUSER=$(echo $DB_URL | sed -n 's|.*://\([^:]*\):.*|\1|p')
            export PHINX_DBPASS=$(echo $DB_URL | sed -n 's|.*://[^:]*:\([^@]*\)@.*|\1|p')
            export PHINX_DBHOST=$(echo $DB_URL | sed -n 's|.*@\([^:]*\):.*|\1|p')
            export PHINX_DBPORT=$(echo $DB_URL | sed -n 's|.*:\([0-9]*\)/.*|\1|p')
            export PHINX_DBNAME=$(echo $DB_URL | sed -n 's|.*/\([^?]*\).*|\1|p')

            # Run database migrations
            vendor/bin/phinx migrate -e production
            vendor/bin/phinx seed:run -e production

            # Clear and warm up Symfony cache
            php bin/console cache:clear --env=prod --no-warmup
            php bin/console cache:warmup --env=prod

            # Set proper permissions
            chgrp -R www-data var/ 2>/dev/null || true
            chmod -R 775 var/ 2>/dev/null || true
            chmod -R g+s var/ 2>/dev/null || true
            chmod 644 config/jwt/public.pem 2>/dev/null || true
            chmod 640 config/jwt/private.pem 2>/dev/null || true
            chgrp www-data config/jwt/*.pem 2>/dev/null || true

            echo "Deployment completed successfully!"
          ENDSSH

      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Backend deployed successfully to production!"
          else
            echo "❌ Deployment failed! Check the logs above."
          fi
